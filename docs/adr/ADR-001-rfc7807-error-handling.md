# ADR-001: Формат ошибок по RFC 7807
Дата: 2025-10-19

Статус: Accepted

## Контекст
В проекте разные места возвращают ошибки в разном формате. В продакшене важно не раскрывать stack trace, но при этом иметь связку между логами и ответом клиенту для разбора инцидентов. Нужен единый формат ошибок и механизм аудита.

## Решение
Ввести единый формат ответов об ошибках согласно RFC 7807 (Problem Details) и централизованную обработку ошибок на уровне middleware:
- Все ошибки приводим к JSON с полями: type, title, status, detail, instance, correlation_id, timestamp.
- Генерируем уникальный correlation_id для каждого запроса и включаем его в ответ и в логи.
- В продакшене не показываем stack trace в ответах; подробности остаются в логах.

## Последствия
- Клиенты получают предсказуемый формат ошибок.
- В логах доступен correlation_id для сопоставления событий.
- Нужна небольшая доработка логирования и тестов.

## Альтернативы
- Оставить стандартные ответы FastAPI и добавить обработчик только для внутренних ошибок. Проще, но формат ошибок будет непоследовательным.
- Нормализовать ошибки на уровне API Gateway. Подойдёт для организованной инфраструктуры, но требует дополнительной настройки вне кода сервиса.

## План внедрения и критерии приёмки
- Реализовать `ErrorHandlerMiddleware` и подключить его в приложении.
- Добавить тесты, проверяющие формат ошибок (см. tests/test_error_handling.py).
- Настроить логирование так, чтобы в логах сохранялся `correlation_id`.
- Критерий приёмки: тесты проходят в CI, в ответах нет stack trace, correlation_id присутствует.

## Ссылки
- NFR-005
- Связь с угрозами: R3, F1
- Тесты: tests/test_error_handling.py::test_rfc7807_error_format
