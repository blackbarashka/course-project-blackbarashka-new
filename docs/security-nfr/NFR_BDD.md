# BDD сценарии для Security NFR

## Сценарий 1: Защита от brute-force атак
**Feature:** Блокировка учётной записи при множественных неуспешных логинах

```gherkin
Scenario: Блокировка учётной записи после 5 неуспешных попыток
  Given произошло 5 неуспешных попыток логина за 5 минут
  When пользователь делает 6-ю попытку логина
  Then возвращается статус 423 (Locked)
  And в теле ответа унифицированное сообщение "Account temporarily locked"
  And в аудит-логе фиксируется событие account_lockout

Scenario: Снятие блокировки через 10 минут
  Given учётная запись заблокирована
  When прошло 10 минут
  Then пользователь может успешно аутентифицироваться
```

## Сценарий 2: Защита от brute-force атак
**Feature:** Ограничение частоты запросов к API

```gherkin
Scenario: Блокировка при превышении лимита создания книг
  Given пользователь отправил 10 POST /api/v1/books за 60 секунд
  When отправляется 11-й запрос
  Then возвращается статус 429 (Too Many Requests)
  And в заголовке присутствует Retry-After
  And в аудит-логе фиксируется событие rate_limited

Scenario: Нормальная работа в пределах лимита
  Given пользователь отправляет 9 POST /api/v1/books за 60 секунд
  When отправляется 10-й запрос
  Then запрос обрабатывается нормально (статус 200)
```

## Сценарий 3: Безопасная обработка ошибок
**Feature:** Защита информации в ошибках

```gherkin
Scenario: Унифицированные ошибки аутентификации
  Given отправлен запрос с неверными credentials
  When система возвращает ошибку
  Then статус 401 (Unauthorized)
  And тело ответа не содержит "invalid password" или "user not found"
  And сообщение унифицировано: "Authentication failed"

Scenario: Отсутствие stack trace в продакшене
  Given произошла внутренняя ошибка сервера
  When система возвращает ответ
  Then статус 500 (Internal Server Error)
  And тело ответа не содержит stack trace или пути к файлам
```

## Сценарий 4: Маскирование данных в логах
**Feature:** Защита конфиденциальности в логах

```gherkin
Scenario: Маскирование email в аудит-логах
  Given пользователь с email "ivan.petrov@example.com" выполняет действие
  When система записывает аудит-лог
  Then в логе email отображается как "i***@e***.com"
  And оригинальный email отсутствует

Scenario: Маскирование персональных данных
  Given в запросе присутствуют персональные данные
  When система обрабатывает запрос
  Then в логах ПДн заменяются на "***"
```

## Негативные сценарии

```gherkin
Scenario: Обработка SQL injection попыток
  Given в параметрах запроса присутствует SQL injection payload
  When система обрабатывает запрос
  Then возвращается статус 400 (Bad Request)
  And запрос не выполняется в базе данных

Scenario: Защита от XSS атак
  Given в названии книги присутствуют script-теги
  When система сохраняет книгу
  Then потенциально опасные символы экранируются
  And при отображении скрипты не выполняются
```
